<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receipt Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-blue-600 p-4 text-white flex justify-between items-center">
    <div class="font-bold text-lg">Receipt Manager</div>
    <div class="space-x-2">
      <button onclick="showPage('upload')" class="px-3 py-1 bg-blue-800 rounded">Upload</button>
      <button onclick="showPage('receipts')" class="px-3 py-1 bg-blue-800 rounded">Receipts</button>
    </div>
  </nav>

  <!-- Upload Page -->
  <div id="uploadPage" class="p-6">
    <h2 class="text-xl font-semibold mb-4">Upload Receipt</h2>
    <form id="uploadForm" class="space-y-4">
      <input type="file" id="receiptInput" name="receipt" accept="image/*" class="block" required>
      <img id="preview" class="max-w-xs hidden border rounded mt-2" />
      <button type="submit" id="uploadBtn" class="bg-blue-600 text-white px-4 py-2 rounded flex items-center mt-2">
        <span id="uploadBtnText">Upload</span>
        <svg id="spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
      </button>
    </form>
    <div id="uploadStatus" class="mt-4"></div>
  </div>

  <!-- Receipts Page -->
  <div id="receiptsPage" class="p-6 hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Receipts</h2>
      <div class="space-x-2">
        <button onclick="loadReceipts()" class="bg-green-600 text-white px-3 py-1 rounded">Refresh</button>
        <button onclick="toggleSort()" id="toggleSortBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Sort by Date</button>
      </div>
    </div>
    <div id="receiptsContainer" class="space-y-4"></div>
  </div>

  <script>
    let currentSort = 'date';

    function showPage(page) {
      document.getElementById('uploadPage').classList.add('hidden');
      document.getElementById('receiptsPage').classList.add('hidden');
      if (page === 'upload') document.getElementById('uploadPage').classList.remove('hidden');
      if (page === 'receipts') {
        document.getElementById('receiptsPage').classList.remove('hidden');
        loadReceipts();
      }
    }

    function toggleSort() {
      currentSort = currentSort === 'date' ? 'category' : 'date';
      document.getElementById('toggleSortBtn').textContent = currentSort === 'date' ? 'Sort by Date' : 'Group by Category';
      loadReceipts();
    }

    // Upload
    document.getElementById('receiptInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const preview = document.getElementById('preview');
          preview.src = ev.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fileInput = document.getElementById('receiptInput');
      if (!fileInput.files[0]) return;
      const formData = new FormData();
      formData.append('receipt', fileInput.files[0]);

      const btn = document.getElementById('uploadBtn');
      const btnText = document.getElementById('uploadBtnText');
      const spinner = document.getElementById('spinner');
      btn.disabled = true; btnText.textContent = 'Uploading...'; spinner.classList.remove('hidden');

      try {
        const res = await fetch('http://localhost:5000/receipts/upload', { method: 'POST', body: formData });
        const text = await res.text();
        let data = JSON.parse(text);
        if (Array.isArray(data) && data.length > 0) data = data[0];

        document.getElementById('uploadStatus').innerHTML = `
          <div class='p-4 bg-green-100 text-green-800 rounded shadow'>
            <div class='font-semibold'>${data.store_name}</div>
            <div>Date: ${new Date(data.date).toLocaleDateString()}</div>
            <div>Total: £${data.total.toFixed(2)}</div>
          </div>
        `;
      } catch (err) {
        document.getElementById('uploadStatus').innerHTML = `<div class='p-4 bg-red-100 text-red-800 rounded shadow'>Error uploading file.</div>`;
      } finally {
        btn.disabled = false; btnText.textContent = 'Upload'; spinner.classList.add('hidden');
      }
    });

    async function loadReceipts() {
      const container = document.getElementById('receiptsContainer');
      container.innerHTML = 'Loading...';
      try {
        const res = await fetch('http://localhost:5000/receipts/get');
        let data = await res.json();
        if (!Array.isArray(data)) data = [];
        renderReceipts(data);
      } catch {
        container.innerHTML = `<div class='p-4 bg-red-100 text-red-800 rounded'>Error loading receipts.</div>`;
      }
    }

    function renderReceipts(receipts) {
      const container = document.getElementById('receiptsContainer');
      container.innerHTML = '';

      if (currentSort === 'date') {
        receipts.sort((a, b) => new Date(b.date) - new Date(a.date));
        receipts.forEach(r => container.appendChild(makeReceiptCard(r)));
      } else {
        const grouped = {};
        receipts.forEach(r => {
          const cat = r.category || 'Uncategorized';
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(r);
        });
        for (const cat in grouped) {
          const section = document.createElement('div');
          section.className = 'category';
          const header = document.createElement('h3');
          header.textContent = cat;
          header.className = 'font-bold text-lg cursor-pointer bg-gray-200 p-2 rounded';
          const groupDiv = document.createElement('div');
          groupDiv.className = 'ml-4 space-y-2';
          grouped[cat].forEach(r => groupDiv.appendChild(makeReceiptCard(r)));
          header.onclick = () => groupDiv.classList.toggle('hidden');
          section.appendChild(header);
          section.appendChild(groupDiv);
          container.appendChild(section);
        }
      }
    }

    function makeReceiptCard(r) {
      const card = document.createElement('div');
      card.className = 'bg-white shadow rounded p-4';
      const date = new Date(r.date).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
      card.innerHTML = `
        <div class='font-semibold'>${r.store_name}</div>
        <div class='text-sm text-gray-600'>${r.location || ''}</div>
        <div class='text-sm'>Date: ${date}</div>
        <div class='text-sm'>Total: £${r.total.toFixed(2)}</div>
        <div class='text-sm'>Category: ${r.category || 'Uncategorized'}</div>
        <button onclick="toggleItems(${r.receipt_id}, this)" class='mt-2 text-blue-600 underline'>View Items</button>
        <div id='items-${r.receipt_id}' class='mt-2 hidden'></div>
      `;
      return card;
    }

    async function toggleItems(id, btn) {
      const div = document.getElementById(`items-${id}`);
      if (!div.classList.contains('hidden')) { div.classList.add('hidden'); btn.textContent = 'View Items'; return; }
      div.innerHTML = 'Loading items...'; div.classList.remove('hidden');
      try {
        const res = await fetch(`http://localhost:5000/receipts/get/items/${id}`);
        let data = await res.json();
        if (!Array.isArray(data)) data = [];
        div.innerHTML = `<ul class='list-disc ml-5'>${data.map(i => `<li>${i.quantity||1} × ${i.name} — £${i.total_price.toFixed(2)}</li>`).join('')}</ul>`;
      } catch {
        div.innerHTML = `<div class='p-2 bg-red-100 text-red-800 rounded'>Error loading items.</div>`;
      }
      btn.textContent = 'Hide Items';
    }
  </script>
</body>
</html>
