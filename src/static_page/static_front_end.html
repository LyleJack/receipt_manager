<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Receipt Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <!-- Navbar -->
  <nav class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center shadow-md">
    <h1 class="text-xl font-bold">Receipt Manager</h1>
    <div class="space-x-4">
      <button onclick="showPage('upload')" class="hover:underline">Upload</button>
      <button onclick="showPage('receipts')" class="hover:underline">Receipts</button>
    </div>
  </nav>

  <!-- Upload Page -->
  <div id="uploadPage" class="p-8">
    <h2 class="text-2xl font-semibold mb-4">Upload a Receipt</h2>
    <form id="uploadForm" action="http://localhost:5000/upload" method="post" enctype="multipart/form-data" class="space-y-4 bg-white p-6 rounded-lg shadow-md max-w-md">
      <input id="fileInput" type="file" name="receipt" accept="image/*" required class="block w-full border border-gray-300 rounded-md p-2" />
      <img id="previewImage" src="" alt="Preview" class="hidden mt-4 max-h-64 rounded-lg shadow" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center">
        <span id="uploadButtonText">Upload</span>
        <svg id="loadingSpinner" class="hidden ml-2 w-5 h-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
      </button>
    </form>
    <pre id="uploadStatus" class="mt-4 text-sm p-3 rounded-lg"></pre>
  </div>

  <!-- Receipts Page -->
  <div id="receiptsPage" class="p-8 hidden">
    <h2 class="text-2xl font-semibold mb-4">All Receipts</h2>
    <button onclick="loadReceipts()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 mb-4">Refresh Receipts</button>
    <pre id="receiptsOutput" class="bg-white p-6 rounded-lg shadow-md overflow-x-auto text-sm"></pre>
  </div>

  <script>
    function showPage(page) {
      document.getElementById('uploadPage').classList.add('hidden');
      document.getElementById('receiptsPage').classList.add('hidden');
      if (page === 'upload') {
        document.getElementById('uploadPage').classList.remove('hidden');
      } else {
        document.getElementById('receiptsPage').classList.remove('hidden');
        loadReceipts();
      }
    }

    // Show image preview
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      const preview = document.getElementById('previewImage');
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = '';
        preview.classList.add('hidden');
      }
    });

    // Handle upload form feedback with spinner and color coding
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const statusEl = document.getElementById('uploadStatus');
      const spinner = document.getElementById('loadingSpinner');
      const buttonText = document.getElementById('uploadButtonText');

      // Reset status and show spinner
      statusEl.textContent = '';
      statusEl.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-gray-200');
      spinner.classList.remove('hidden');
      buttonText.textContent = 'Uploading...';

      try {
        const res = await fetch(e.target.action, {
          method: 'POST',
          body: formData
        });
        spinner.classList.add('hidden');
        buttonText.textContent = 'Upload';

        if (res.ok) {
          const data = await res.json();
          statusEl.textContent = JSON.stringify(data, null, 2);
          statusEl.classList.add('bg-green-100', 'text-green-700');
          e.target.reset();
          document.getElementById('previewImage').classList.add('hidden');
        } else {
          const text = await res.text();
          statusEl.textContent = `Upload failed: ${text}`;
          statusEl.classList.add('bg-red-100', 'text-red-700');
        }
      } catch (err) {
        spinner.classList.add('hidden');
        buttonText.textContent = 'Upload';
        statusEl.textContent = 'Error uploading file.';
        statusEl.classList.add('bg-red-100', 'text-red-700');
      }
    });

    // Fetch and pretty print receipts
    async function loadReceipts() {
      try {
        const res = await fetch('http://localhost:5000/receipts');
        if (!res.ok) throw new Error('Failed to fetch receipts');
        const data = await res.json();

        // Sort categories alphabetically for display
        const sorted = {};
        Object.keys(data).sort().forEach(key => {
          sorted[key] = data[key];
        });

        document.getElementById('receiptsOutput').textContent = JSON.stringify(sorted, null, 2);
      } catch (err) {
        document.getElementById('receiptsOutput').textContent = 'Error loading receipts.';
      }
    }
  </script>
</body>
</html>
